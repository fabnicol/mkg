\hypertarget{_2home_2fab_2_dev_2mkgentoo_2scripts_2mkgentoo_8sh-example}{}\doxysection{/home/fab/\+Dev/mkgentoo/scripts/mkgentoo.\+sh}

\begin{DoxyCode}{0}
\DoxyCodeLine{mkgentoo language=fr minimal=\textcolor{keyword}{true} debug\_mode=\textcolor{keyword}{true} ncpus=8 nonroot\_user=ken passwd=\textcolor{stringliteral}{'util!Hx\&32F'} rootpasswd=\textcolor{stringliteral}{'Hk\_32!\_CD'} cleanup=\textcolor{keyword}{false}}
\end{DoxyCode}



\begin{DoxyCodeInclude}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Copyright (c) 2020 Fabrice Nicol <fabrnicol@gmail.com>}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# This file is part of mkgentoo.}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# mkgentoo is free software; you can redistribute it and/or}}
\DoxyCodeLine{\textcolor{preprocessor}{\# modify it under the terms of the GNU Lesser General Public}}
\DoxyCodeLine{\textcolor{preprocessor}{\# License as published by the Free Software Foundation; either}}
\DoxyCodeLine{\textcolor{preprocessor}{\# version 3 of the License, or (at your option) any later version.}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# FFmpeg is distributed in the hope that it will be useful,}}
\DoxyCodeLine{\textcolor{preprocessor}{\# but WITHOUT ANY WARRANTY; without even the implied warranty of}}
\DoxyCodeLine{\textcolor{preprocessor}{\# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Lesser General Public License for more details.}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# You should have received a copy of the GNU Lesser General Public}}
\DoxyCodeLine{\textcolor{preprocessor}{\# License along with FFmpeg; if not, write to the Free Software}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\#}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\#!/bin/bash}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @file mkgentoo.sh}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @author Fabrice Nicol <fabrnicol@gmail.com>}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @copyright GPL v.3}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @brief Process options, create Gentoo VirtualBox machine and optionally create clonezilla install medium}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @note This file is not included into the clonezilla ISO liveCD.}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @defgroup createInstaller Create Gentoo linux image and installer.}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @par USAGE}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @code}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# mkgentoo  [[switch=argument]...]  filename.iso  [1]}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# mkgentoo  [[switch=argument]...]                [2]}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# mkgentoo  help[=md]                             [3]}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @endcode}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @par}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# Usage [1] creates a bootable ISO output file with a current Gentoo distribution.   @n}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# Usage [2] creates a VirtualBox VDI dynamic disk and a virtual machine with name Gentoo.   @n}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# Usage [3] prints this help, in markdown form if argument 'md' is specified.  @n}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @par}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# Run: @code mkgentoo help @endcode to print a list of possible switches and arguments.}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @warning you should have at least 55 GB of free disk space in the current directory or in vmpath if specified.}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# Boolean values are either 'true' or 'false'. For example, to build a minimal distribution,}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# specify <tt> minimal=true</tt> on command line.}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @example}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @code}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# mkgentoo language=fr minimal=true debug\_mode=true ncpus=8 nonroot\_user=ken passwd='util!Hx\&32F' rootpasswd='Hk\_32!\_CD' cleanup=false}}
\DoxyCodeLine{\textcolor{preprocessor}{\#\# @endcode}}
\DoxyCodeLine{}
\DoxyCodeLine{cd ..}
\DoxyCodeLine{}
\DoxyCodeLine{CLI=\textcolor{stringliteral}{"\$*"}}
\DoxyCodeLine{}
\DoxyCodeLine{declare -\/a \mbox{\hyperlink{mkgentoo_8sh_a214cb10953cb8efbb6a2092fdb4ff6fd}{ARR}}}
\DoxyCodeLine{}
\DoxyCodeLine{\mbox{\hyperlink{mkgentoo_8sh_a214cb10953cb8efbb6a2092fdb4ff6fd}{ARR}}=(\textcolor{stringliteral}{"minimal"}     \textcolor{stringliteral}{"Remove *libreoffice* and *data science tools* from default list of installed software"}  \textcolor{stringliteral}{"false"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"elist"}       \textcolor{stringliteral}{"\(\backslash\)t File containing a list of Gentoo ebuilds to add to the VM on top of stage3"} \textcolor{stringliteral}{"ebuilds.list"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"vm"}          \textcolor{stringliteral}{"\(\backslash\)t Virtual Machine name"}                                             \textcolor{stringliteral}{"Gentoo"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"vbpath"}      \textcolor{stringliteral}{"Path to VirtualBox directory"}                                        \textcolor{stringliteral}{"/usr/bin"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"vmpath"}      \textcolor{stringliteral}{"Path to VM base directory"}                                           \textcolor{stringliteral}{"\$PWD"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"mem"}         \textcolor{stringliteral}{"\(\backslash\)t VM RAM memory in MiB"}                                             \textcolor{stringliteral}{"8000"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"ncpus"}       \textcolor{stringliteral}{"\(\backslash\)t Number of VM CPUs. By default the third of available threads."}    \textcolor{stringliteral}{"\$((\$(nproc -\/-\/all)/3))"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"processor"}   \textcolor{stringliteral}{"Processor type"}                                                      \textcolor{stringliteral}{"amd64"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"size"}        \textcolor{stringliteral}{"\(\backslash\)t Dynamic disc size"}                                                \textcolor{stringliteral}{"55000"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"livecd"}      \textcolor{stringliteral}{"Path to the live CD that will start the VM"}                          \textcolor{stringliteral}{"gentoo.iso"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"mirror"}      \textcolor{stringliteral}{"Mirror site for downloading of stage3 tarball"}                       \textcolor{stringliteral}{"http://gentoo.mirrors.ovh.net/gentoo-\/distfiles/"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"emirrors"}    \textcolor{stringliteral}{"Mirror sites for downloading ebuilds"}                                \textcolor{stringliteral}{"http://gentoo.mirrors.ovh.net/gentoo-\/distfiles/"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"rstudio"}     \textcolor{stringliteral}{"RStudio version to be downloaded and built from github source"}       \textcolor{stringliteral}{"1.3.1073"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"r\_version"}   \textcolor{stringliteral}{"R version"}                                                           \textcolor{stringliteral}{"4.0.2"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"githubpath"}  \textcolor{stringliteral}{"RStudio Github path to zip: path right before version.zip"}           \textcolor{stringliteral}{"https://github.com/rstudio/rstudio/archive/v"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"cflags"}      \textcolor{stringliteral}{"GCC CFLAGS options for ebuilds"}                                      \textcolor{stringliteral}{"-\/march=core-\/avx2 -\/O2"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"nonroot\_user"} \textcolor{stringliteral}{"Non-\/root user"}                                                      \textcolor{stringliteral}{"fab"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"passwd"}      \textcolor{stringliteral}{"User password"}                                                       \textcolor{stringliteral}{"dev20"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"rootpasswd"}  \textcolor{stringliteral}{"Root password"}                                                       \textcolor{stringliteral}{"dev20"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"download"}    \textcolor{stringliteral}{"Download install ISO image from Gentoo mirror"}                       \textcolor{stringliteral}{"true"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"download\_stage3"} \textcolor{stringliteral}{"Download and install stage3 tarball to virtual disk"}             \textcolor{stringliteral}{"true"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"download\_rstudio"}  \textcolor{stringliteral}{"Download and build RStudio"}                                    \textcolor{stringliteral}{"true"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"download\_clonezilla"} \textcolor{stringliteral}{"Refresh CloneZilla ISO download"}                             \textcolor{stringliteral}{"true"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"download\_clonezilla\_path"} \textcolor{stringliteral}{"Use the following CloneZilla ISO"}                       \textcolor{stringliteral}{"https://sourceforge.net/projects/clonezilla/files/clonezilla\_live\_alternative/20200703-\/focal/clonezilla-\/live-\/20200703-\/focal-\/amd64.iso/download"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"build\_virtualbox"}   \textcolor{stringliteral}{"Download code source and automatically build virtualbox and tools"} \textcolor{stringliteral}{"false"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"vbox\_version"}  \textcolor{stringliteral}{"Virtualbox version"}                                                \textcolor{stringliteral}{"6.1.14"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"vbox\_version\_full"} \textcolor{stringliteral}{"Virtualbox full version"}                                       \textcolor{stringliteral}{"6.1.14a"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"lineno\_patch"} \textcolor{stringliteral}{"Line patched against vbox-\/img.cpp in virtualbox source code"}        \textcolor{stringliteral}{"797"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"stage3"}      \textcolor{stringliteral}{"Path to stage3 archive"}                                              \textcolor{stringliteral}{"stage3.tar.xz"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"create\_squashfs"}  \textcolor{stringliteral}{"(Re)create the squashfs filesystem"}                             \textcolor{stringliteral}{"true"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"vmtype"}      \textcolor{stringliteral}{"gui or headless (silent)"}                                            \textcolor{stringliteral}{"headless"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"kernel\_config"}  \textcolor{stringliteral}{"Use a custom kernel config file"}                                  \textcolor{stringliteral}{".config"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"language"}    \textcolor{stringliteral}{"Set default login keyboard layout"}                                   \textcolor{stringliteral}{"us"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"burn"}        \textcolor{stringliteral}{"Burn to optical disc. Argument is either a device label (e.g. cdrom, sr0) or a mountpoint directory."}  \textcolor{stringliteral}{"false"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"scsi\_address"} \textcolor{stringliteral}{"In case of several optical disc burners, specify the SCSI address as x,y,z"}  \textcolor{stringliteral}{"0,0,0"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"usb\_device"}  \textcolor{stringliteral}{"Create Gentoo OS on external device. Argument is either a device label (e.g. sdb1, hdb1), or a mountpoint directory (if mounted), or a few consecutive letters of the model (e.g. 'Samsu', 'PNY' or 'Kingst'), if there is just one such."}    \textcolor{stringliteral}{""}}
\DoxyCodeLine{     \textcolor{stringliteral}{"usb\_installer"} \textcolor{stringliteral}{"Create Gentoo clone installer on external device. Argument is either a device label (e.g. sdb2, hdb2), or a mountpoint directory (if mounted), or a few consecutive letters of the model, if there is just one such. If unspecified, **usb\_device** value will be used. OS Gentoo will be replaced by Clonezilla installer."}  \textcolor{stringliteral}{""}}
\DoxyCodeLine{     \textcolor{stringliteral}{"disable\_md5\_check"} \textcolor{stringliteral}{"Disable MD5 checkums verification after downloads"}             \textcolor{stringliteral}{"true"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"cleanup"}       \textcolor{stringliteral}{"Clean up archives, temporary images and virtual machine after successful completion"}  \textcolor{stringliteral}{"true"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"debug\_mode"}  \textcolor{stringliteral}{"Do not clean up mkgentoo custom logs at root of gentoo system files before VM shutdown"}  \textcolor{stringliteral}{"false"}}
\DoxyCodeLine{     \textcolor{stringliteral}{"help"}          \textcolor{stringliteral}{"\(\backslash\)t This help"}                                                         \textcolor{stringliteral}{""}}
\DoxyCodeLine{}
\DoxyCodeLine{    )}
\DoxyCodeLine{}
\DoxyCodeLine{ARRAY\_LENGTH=\$((\$\{\#\mbox{\hyperlink{mkgentoo_8sh_a214cb10953cb8efbb6a2092fdb4ff6fd}{ARR}}[*]\}/3))}
\DoxyCodeLine{}
\DoxyCodeLine{ISO=\textcolor{stringliteral}{"downloaded.iso"}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# test\_cli}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Analyses commandline}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# arguments :}}
\DoxyCodeLine{\textcolor{preprocessor}{\#  cli          Commandline}}
\DoxyCodeLine{\textcolor{preprocessor}{\# creates globals of the form VAR=arg  when there is var=arg on commandline}}
\DoxyCodeLine{\textcolor{preprocessor}{\# otherwise assigns default values VAR=defaults (3rd argument in array ARR)}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} test\_cli \{}
\DoxyCodeLine{\textcolor{preprocessor}{   \# check version}}
\DoxyCodeLine{   local vbox\_version=\$(VBoxManage -\/v)}
\DoxyCodeLine{   local version\_major=\$(echo \$\{vbox\_version\} | sed -\/E \textcolor{stringliteral}{'s/([0-\/9]+)\(\backslash\)..*/\(\backslash\)1/'})}
\DoxyCodeLine{   local version\_minor=\$(echo \$\{vbox\_version\} | sed -\/E \textcolor{stringliteral}{'s/[0-\/9]+\(\backslash\).([0-\/9]+)\(\backslash\)..*/\(\backslash\)1/'})}
\DoxyCodeLine{   local version\_index=\$(echo \$\{vbox\_version\} | sed -\/E \textcolor{stringliteral}{'s/[0-\/9]+\(\backslash\).[0-\/9]+\(\backslash\).([0-\/9][0-\/9]).*/\(\backslash\)1/'})}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$\{version\_major\} -\/lt 6 -\/o \$\{version\_minor\} -\/lt 1 -\/o \$\{version\_index\} -\/lt 10; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"VirtualBox must be at least version 6.1.14"}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Please update and reinstall"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   local sw=\$\{\mbox{\hyperlink{mkgentoo_8sh_a214cb10953cb8efbb6a2092fdb4ff6fd}{ARR}}[\$((\$1 * 3))]\}}
\DoxyCodeLine{   local desc=\$\{\mbox{\hyperlink{mkgentoo_8sh_a214cb10953cb8efbb6a2092fdb4ff6fd}{ARR}}[\$((\$1 * 3 + 1))]\}}
\DoxyCodeLine{   local \textcolor{keywordflow}{default}=\$\{\mbox{\hyperlink{mkgentoo_8sh_a214cb10953cb8efbb6a2092fdb4ff6fd}{ARR}}[\$((\$1 * 3 + 2))]\}}
\DoxyCodeLine{   local vm\_arg=\$(echo \$\{CLI\} | sed -\/E \textcolor{stringliteral}{"s/(\string^\$\{sw\}|.* \$\{sw\})=([\string^ ]+).*/\(\backslash\)2/"})}
\DoxyCodeLine{   ISO\_OUTPUT=\$(echo \$\{CLI\} | sed -\/E \textcolor{stringliteral}{'s/.*(\(\backslash\)b\(\backslash\)w+)\(\backslash\).(iso|ISO)/\(\backslash\)1\(\backslash\).iso/'})}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \textcolor{stringliteral}{"\$\{ISO\_OUTPUT\}"} != \textcolor{stringliteral}{""} -\/a \textcolor{stringliteral}{"\$\{ISO\_OUTPUT\}"} != \textcolor{stringliteral}{"\$\{CLI\}"}; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Build Gentoo distribution to bootable ISO output \$\{ISO\_OUTPUT\}"}}
\DoxyCodeLine{       CREATE\_ISO=\textcolor{stringliteral}{"true"}}
\DoxyCodeLine{   \textcolor{keywordflow}{else}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"You did not indicate an ISO output file."}}
\DoxyCodeLine{       !    echo \textcolor{stringliteral}{"A Virtual machine will be created with name Gentoo under \$HOME"}}
\DoxyCodeLine{       CREATE\_ISO=\textcolor{stringliteral}{"false"}}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   VAR=\$(echo \$\{sw\} | tr \textcolor{stringliteral}{"[a-\/z]"} \textcolor{stringliteral}{"[A-\/Z]"})}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \textcolor{stringliteral}{"\$\{vm\_arg\}"} != \textcolor{stringliteral}{""} -\/a \textcolor{stringliteral}{"\$\{vm\_arg\}"} != \textcolor{stringliteral}{"\$\{CLI\}"} ; then  \# No args or no option}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"\$\{desc\}"} = \textcolor{stringliteral}{"\$\{vm\_arg\}"} | sed \textcolor{stringliteral}{'s/\(\backslash\)\(\backslash\)t //'}}
\DoxyCodeLine{       eval \textcolor{stringliteral}{"\$\{VAR\}"}=\textcolor{stringliteral}{"\(\backslash\)"\$\{vm\_arg\}\(\backslash\)""}}
\DoxyCodeLine{   \textcolor{keywordflow}{else}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"\$\{desc\}"} = \textcolor{stringliteral}{"\$\{default\}"} | sed \textcolor{stringliteral}{'s/\(\backslash\)\(\backslash\)t //'}}
\DoxyCodeLine{       eval \textcolor{stringliteral}{"\$\{VAR\}"}=\textcolor{stringliteral}{"\(\backslash\)"\$\{default\}\(\backslash\)""}}
\DoxyCodeLine{   fi}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# check\_md5sum}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Checks md5sums in file MD5SUMS}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Returns 0 on success otherwise -\/1 on exit}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} check\_md5sum \{}
\DoxyCodeLine{   local ref=\$(cat MD5SUMS | grep \textcolor{stringliteral}{"\$1"} | cut -\/f 1 -\/d\textcolor{charliteral}{' '})}
\DoxyCodeLine{   downloaded=\$(md5sum \$1 | cut -\/f 1 -\/d\textcolor{charliteral}{' '})}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$\{downloaded\} = \$\{ref\}; then}
\DoxyCodeLine{       \textcolor{keywordflow}{return} 0}
\DoxyCodeLine{   \textcolor{keywordflow}{else}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"MD5 checkum for \$1 is not correct. Please download manually..."}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# help}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Prints usage}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} help\_md \{}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"**USAGE:**  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"**mkgentoo**  [[switch=argument]...]  filename.iso  [1]  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"**mkgentoo**  [[switch=argument]...]                [2]  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"**mkgentoo**  help[=md]                             [3]  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"Usage [1] creates a bootable ISO output file with a current Gentoo distribution.  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"Usage [2] creates a VirtualBox VDI dynamic disk and a virtual machine with name Gentoo.  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"Usage [3] prints this help, in markdown form if argument 'md' is specified.  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"Warning: you should have at least 55 GB of free disk space in the current directory or in vmpath if specified.  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"**Switches:**  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"Boolean values are either 'true' or 'false'. For example, to build a minimal distribution, specify:  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{">  minimal=true  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"on command line.  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{" | switch | description | default value |  "}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{" |:-\/-\/-\/-\/-\/:|:-\/-\/-\/-\/-\/-\/-\/-\/:|:-\/-\/-\/-\/-\/:|  "}}
\DoxyCodeLine{   \textcolor{keywordflow}{for} ((i=0; i<\$\{ARRAY\_LENGTH\}; i++)); \textcolor{keywordflow}{do}}
\DoxyCodeLine{       local sw=\$((\$i*3))}
\DoxyCodeLine{       local desc=\$((\$i*3+1))}
\DoxyCodeLine{       local def=\$((\$i*3+2))}
\DoxyCodeLine{       echo -\/e \textcolor{stringliteral}{"| \$\{ARR[\$sw]\} \(\backslash\)t| \$\{ARR[\$desc]\} \(\backslash\)t| [\$\{ARR[\$def]\}] |  "}}
\DoxyCodeLine{   done}
\DoxyCodeLine{   echo}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} help \{}
\DoxyCodeLine{   help\_md | sed \textcolor{stringliteral}{'s/[\(\backslash\)*\(\backslash\)|\(\backslash\)>]//g'}}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# fetch\_livecd}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Downloads Gentoo install CD}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Caches it as \$\{ISO\}}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Returns 0 on success or -\/1 on exit}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} fetch\_livecd \{}
\DoxyCodeLine{   local CACHED\_ISO=\textcolor{stringliteral}{"install-\/\$\{PROCESSOR\}-\/minimal.iso"}}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$\{DOWNLOAD\} = \textcolor{stringliteral}{"false"}; then}
\DoxyCodeLine{       \textcolor{keywordflow}{if} test -\/f \$\{CACHED\_ISO\}; then}
\DoxyCodeLine{           cp -\/vf \$\{CACHED\_ISO\} \$\{ISO\}}
\DoxyCodeLine{           LIVECD=\$\{ISO\}}
\DoxyCodeLine{           \textcolor{keywordflow}{return} 0}
\DoxyCodeLine{       \textcolor{keywordflow}{else}}
\DoxyCodeLine{           echo \textcolor{stringliteral}{"No ISO file was found, please rerun with download=true"}}
\DoxyCodeLine{           exit -\/1}
\DoxyCodeLine{       fi}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   rm install-\/\$\{PROCESSOR\}-\/minimal*\(\backslash\).iso*}
\DoxyCodeLine{   rm latest-\/install-\/\$\{PROCESSOR\}-\/minimal*\(\backslash\).txt*}
\DoxyCodeLine{   local downloaded=\textcolor{stringliteral}{""}}
\DoxyCodeLine{   wget \$\{MIRROR\}/releases/\$\{PROCESSOR\}/autobuilds/latest-\/install-\/\$\{PROCESSOR\}-\/minimal.txt}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$? != 0; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Could not download live CD from Gentoo mirror"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   local current=\$(cat latest-\/install-\/\$\{PROCESSOR\}-\/minimal.txt | grep \textcolor{stringliteral}{"install-\/\$\{PROCESSOR\}-\/minimal.*.iso"} | sed -\/E \textcolor{stringliteral}{'s/iso.*\$/iso/'} )}
\DoxyCodeLine{   local downloaded=\$(basename \$\{current\})}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"Downloading \$current..."}}
\DoxyCodeLine{   wget \textcolor{stringliteral}{"\$\{MIRROR\}/releases/\$\{PROCESSOR\}/autobuilds/\$\{current\}"}}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$? != 0; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Could not download live CD"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   \textcolor{keywordflow}{else}}
\DoxyCodeLine{       \textcolor{keywordflow}{if} test \$\{DISABLE\_MD5\_CHECK\} = \textcolor{stringliteral}{"false"}; then}
\DoxyCodeLine{           check\_md5sum \$\{downloaded\}}
\DoxyCodeLine{       fi}
\DoxyCodeLine{       \textcolor{keywordflow}{if} test -\/f \$\{downloaded\}; then}
\DoxyCodeLine{           cp -\/vf \$\{downloaded\} \$\{CACHED\_ISO\}}
\DoxyCodeLine{           mv \$\{downloaded\} \$\{ISO\}}
\DoxyCodeLine{           \textcolor{keywordflow}{if} test -\/f \$\{ISO\}; then}
\DoxyCodeLine{               LIVECD=\$\{ISO\}}
\DoxyCodeLine{           \textcolor{keywordflow}{else}}
\DoxyCodeLine{               echo \textcolor{stringliteral}{"No active ISO (downloaded.iso) file!"}}
\DoxyCodeLine{               exit -\/1}
\DoxyCodeLine{           fi}
\DoxyCodeLine{       \textcolor{keywordflow}{else}}
\DoxyCodeLine{           echo \textcolor{stringliteral}{"Could not find downloaded live CD \$\{downloaded\}"}}
\DoxyCodeLine{           exit -\/1}
\DoxyCodeLine{       fi}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{return} 0}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# fetch\_stage3}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Downloads a fresh stage3 Gentoo archive}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Caches it as \$\{STAGE3\}}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Returns 0 on success or -\/1 on exit}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} fetch\_stage3 \{}
\DoxyCodeLine{\textcolor{preprocessor}{   \# Fetching stage3 tarball}}
\DoxyCodeLine{   local CACHED\_STAGE3=\textcolor{stringliteral}{"stage3-\/\$\{PROCESSOR\}.tar.xz"}}
\DoxyCodeLine{   echo \textcolor{stringliteral}{"download\_stage3=\$\{DOWNLOAD\_STAGE3\}"}}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$\{DOWNLOAD\_STAGE3\} = \textcolor{stringliteral}{"true"}; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Cleaning up stage3 data..."}}
\DoxyCodeLine{       rm -\/vf latest-\/stage3*.txt*}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Downloading stage3 data..."}}
\DoxyCodeLine{       wget \$\{MIRROR\}/releases/\$\{PROCESSOR\}/autobuilds/latest-\/stage3-\/\$\{PROCESSOR\}.txt}
\DoxyCodeLine{       \textcolor{keywordflow}{if} test \$? != 0; then}
\DoxyCodeLine{           echo \textcolor{stringliteral}{"Could not download stage3 from mirrors: \$\{MIRROR\}/releases/\$\{PROCESSOR\}/autobuilds/latest-\/stage3-\/\$\{PROCESSOR\}.txt"}}
\DoxyCodeLine{           exit -\/1}
\DoxyCodeLine{       fi}
\DoxyCodeLine{   \textcolor{keywordflow}{else}}
\DoxyCodeLine{       \textcolor{keywordflow}{if} ! test -\/f latest-\/stage3-\/\$\{PROCESSOR\}.txt; then}
\DoxyCodeLine{           echo \textcolor{stringliteral}{"No stage 3 download information available!"}}
\DoxyCodeLine{           echo \textcolor{stringliteral}{"Rerun with download\_stage3=true"}}
\DoxyCodeLine{           exit -\/1}
\DoxyCodeLine{       fi}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   local current=\$(cat latest-\/stage3-\/\$\{PROCESSOR\}.txt | grep \textcolor{stringliteral}{"stage3-\/\$\{PROCESSOR\}.*.tar.xz"} | cut -\/f 1 -\/d\textcolor{charliteral}{' '})}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$\{DOWNLOAD\_STAGE3\} = \textcolor{stringliteral}{"true"}; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Cleaning up stage3 archives(s)..."}}
\DoxyCodeLine{       rm -\/vf stage3-\/\$\{PROCESSOR\}-\/*tar.xz*}
\DoxyCodeLine{       rm  \$\{STAGE3\}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Downloading \$\{current\}..."}}
\DoxyCodeLine{       wget \textcolor{stringliteral}{"\$\{MIRROR\}/releases/\$\{PROCESSOR\}/autobuilds/\$\{current\}"}}
\DoxyCodeLine{       \textcolor{keywordflow}{if} test \$? != 0; then}
\DoxyCodeLine{           echo \textcolor{stringliteral}{"Could not download stage3 tarball from mirror: \$\{MIRROR\}/releases/\$\{PROCESSOR\}/autobuilds/\$\{current\}"}}
\DoxyCodeLine{           exit -\/1}
\DoxyCodeLine{       fi}
\DoxyCodeLine{       \textcolor{keywordflow}{if} test \$\{DISABLE\_MD5\_CHECK\} = \textcolor{stringliteral}{"false"}; then}
\DoxyCodeLine{           check\_md5sum \$(basename \$\{current\})}
\DoxyCodeLine{       fi}
\DoxyCodeLine{       cp -\/vf \$(echo \$\{current\} | sed \textcolor{stringliteral}{'s/.*stage3/stage3/'})  \$\{CACHED\_STAGE3\}}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} ! test -\/f \textcolor{stringliteral}{"\$\{CACHED\_STAGE3\}"}; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"No stage3 tarball!"}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Rerun with download\_stage3=true"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   cp -\/vf \$\{CACHED\_STAGE3\} \$\{STAGE3\}}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# make\_boot\_from\_livecd}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Unless create\_squashfs=false is given on commandline}}
\DoxyCodeLine{\textcolor{preprocessor}{\# tweaks the Gentoo minimal install CD so that the custom-\/}}
\DoxyCodeLine{\textcolor{preprocessor}{\# made shell scripts are included into the squashfs filesystem}}
\DoxyCodeLine{\textcolor{preprocessor}{\# as well as the stage3 archive.}}
\DoxyCodeLine{\textcolor{preprocessor}{\# to be run in the \$\{VM\} virtual machine}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Returns  0 on success or -\/1 on exit}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} make\_boot\_from\_livecd \{}
\DoxyCodeLine{   \textcolor{keywordflow}{if} ! test -\/f \$\{ISO\}; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"No active ISO file in current directory!"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$\{CREATE\_SQUASHFS\} = \textcolor{stringliteral}{"false"}; then}
\DoxyCodeLine{       \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   mountpoint -\/q mnt \&\& sudo umount -\/l mnt}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test -\/d mnt; then}
\DoxyCodeLine{       sudo rm -\/rf mnt}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   mkdir mnt}
\DoxyCodeLine{   sudo mount -\/oloop \$\{ISO\} mnt/}
\DoxyCodeLine{   ! mountpoint -\/q mnt \&\& echo \textcolor{stringliteral}{"ISO not mounted!"} \&\& exit -\/1}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test -\/d mnt2; then}
\DoxyCodeLine{       sudo rm -\/rf mnt2}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   mkdir mnt2}
\DoxyCodeLine{   rsync -\/av mnt/ mnt2}
\DoxyCodeLine{   cd mnt2/isolinux}
\DoxyCodeLine{   sed -\/i \textcolor{stringliteral}{'s/timeout.*/timeout 1/'} isolinux.cfg}
\DoxyCodeLine{   sed -\/i \textcolor{stringliteral}{'s/ontimeout.*/ontimeout gentoo/'} isolinux.cfg}
\DoxyCodeLine{   cd ..}
\DoxyCodeLine{   sudo unsquashfs image.squashfs}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$? != 0; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"unsquashfs failed !"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   cd ..}
\DoxyCodeLine{   \textcolor{keywordflow}{if} ! test -\/f scripts/mkvm.sh; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"No mkvm.sh script!"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} ! test -\/f scripts/mkvm\_chroot.sh; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"No mkvm\_chroot.sh script!"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \textcolor{stringliteral}{"\$\{MINIMAL\}"} = \textcolor{stringliteral}{"true"} -\/a \textcolor{stringliteral}{"\$\{ELIST\}"} = \textcolor{stringliteral}{"ebuilds.list"}; then}
\DoxyCodeLine{       cp -\/vf \$\{ELIST\}.minimal \$\{ELIST\}}
\DoxyCodeLine{   \textcolor{keywordflow}{else}}
\DoxyCodeLine{       cp -\/vf \$\{ELIST\}.complete \$\{ELIST\}}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} ! test -\/f \$\{ELIST\}; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"No ebuild list!"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} ! test -\/f \$\{STAGE3\}; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"No stage3 archive!"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} ! test -\/f \$\{KERNEL\_CONFIG\}; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"No kernel configuration file!"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   local sqrt=\textcolor{stringliteral}{"mnt2/squashfs-\/root/root/"}}
\DoxyCodeLine{   sudo chown fab \$\{sqrt\}}
\DoxyCodeLine{   mv -\/vf \$\{STAGE3\} \$\{sqrt\}}
\DoxyCodeLine{   cp -\/vf scripts/mkvm.sh \$\{sqrt\}}
\DoxyCodeLine{   chmod +x \$\{sqrt\}mkvm.sh}
\DoxyCodeLine{   cp -\/vf scripts/mkvm\_chroot.sh \$\{sqrt\}}
\DoxyCodeLine{   chmod +x \$\{sqrt\}mkvm\_chroot.sh}
\DoxyCodeLine{   cp -\/vf \$\{ELIST\} \$\{sqrt\}}
\DoxyCodeLine{   cp -\/vf \$\{KERNEL\_CONFIG\} \$\{sqrt\}}
\DoxyCodeLine{   cd \$\{sqrt\}}
\DoxyCodeLine{   rc=\textcolor{stringliteral}{".bashrc"}}
\DoxyCodeLine{   cp -\/vf /etc/bash.bashrc \$\{rc\}}
\DoxyCodeLine{   \textcolor{keywordflow}{for} ((i=0; i<ARRAY\_LENGTH; i++)); \textcolor{keywordflow}{do}}
\DoxyCodeLine{       local  capname=\$\{\mbox{\hyperlink{mkgentoo_8sh_a214cb10953cb8efbb6a2092fdb4ff6fd}{ARR}}[\$((i * 3))]\string^\string^\}}
\DoxyCodeLine{       local  expstring=\textcolor{stringliteral}{"export \$\{capname\}=\(\backslash\)"\$\{!capname\}\(\backslash\)""}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"\$\{expstring\}"}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"\$\{expstring\}"} >> \$\{rc\}}
\DoxyCodeLine{   done}
\DoxyCodeLine{   echo  \textcolor{stringliteral}{"/bin/bash mkvm.sh"}  >> \$\{rc\}}
\DoxyCodeLine{   cd ../..}
\DoxyCodeLine{   rm  image.squashfs}
\DoxyCodeLine{   sudo mksquashfs squashfs-\/root/ image.squashfs}
\DoxyCodeLine{   sudo rm -\/rf squashfs-\/root/}
\DoxyCodeLine{   cd ..}
\DoxyCodeLine{   mkisofs -\/J -\/R -\/o  \$\{ISO\} -\/b isolinux/isolinux.bin  -\/c isolinux/boot.cat  -\/no-\/emul-\/boot -\/boot-\/load-\/size 4  -\/boot-\/info-\/table  mnt2}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$? != 0; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"mkisofs could not recreate the ISO file to boot virtual machine \$\{VM\}"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   sudo umount -\/l mnt}
\DoxyCodeLine{   sudo chown -\/R fab .}
\DoxyCodeLine{   rm -\/rvf mnt}
\DoxyCodeLine{   rm -\/rvf mnt2}
\DoxyCodeLine{   \textcolor{keywordflow}{return} 0}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# test\_vm\_running}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Checks if VM as first named argument exists and is running}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Returns 0 on success and 1 is VM is not listed or not running}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} test\_vm\_running \{}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \textcolor{stringliteral}{"\$(VBoxManage list vms | grep "}\$1\textcolor{stringliteral}{")"} != \textcolor{stringliteral}{""} -\/a \textcolor{stringliteral}{"\$(VBoxManage list runningvms | grep "}\$1\textcolor{stringliteral}{")"} != \textcolor{stringliteral}{""}; then}
\DoxyCodeLine{       \textcolor{keywordflow}{return} 0}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{return} 1}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# delete\_vm}}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Powers off, possibly with emergency stop, the VM names as first argument}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Unregisters it}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Deletes its folder structure and hard drive (default is "vdi" as a second argument)}}
\DoxyCodeLine{\textcolor{preprocessor}{\# Returns 0 if Directory and hard drive could be erased, otherwise the OR value of both}}
\DoxyCodeLine{\textcolor{preprocessor}{\# erasing commands}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} delete\_vm  \{}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test\_vm\_running \textcolor{stringliteral}{"\$1"}; then}
\DoxyCodeLine{       VBoxManage controlvm \textcolor{stringliteral}{"\$1"} poweroff}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test\_vm\_running \textcolor{stringliteral}{"\$1"}; then}
\DoxyCodeLine{       VBoxManage startvm \$1 -\/-\/type emergencystop}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \textcolor{stringliteral}{"\$(VBoxManage list vms | grep "}\$1\textcolor{stringliteral}{")"} != \textcolor{stringliteral}{""}; then}
\DoxyCodeLine{       VBoxManage unregistervm \textcolor{stringliteral}{"\$1"} -\/-\/\textcolor{keyword}{delete}}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test -\/d \textcolor{stringliteral}{"\$\{VMPATH\}/\$1"}; then}
\DoxyCodeLine{       sudo rm -\/rvf  \textcolor{stringliteral}{"\$\{VMPATH\}/\$1"}}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   res=\$?}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \textcolor{stringliteral}{"\$2"} != \textcolor{stringliteral}{""} -\/a -\/f \textcolor{stringliteral}{"\$\{VMPATH\}/\$1.\$2"}; then}
\DoxyCodeLine{       sudo rm -\/f   \textcolor{stringliteral}{"\$\{VMPATH\}/\$1.\$2"}}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   res=\$((\$? | \$\{res\}))}
\DoxyCodeLine{   \textcolor{keywordflow}{return} \$\{res\}}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\# mkvm.sh should be adjacent to mkgentoo.sh}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} create\_vm \{}
\DoxyCodeLine{   export \mbox{\hyperlink{mkgentoo_8sh_ad1451b50408769582d8f5bd4254fe7b1}{PATH}}=\$\{\mbox{\hyperlink{mkgentoo_8sh_ad1451b50408769582d8f5bd4254fe7b1}{PATH}}\}:\$\{VBPATH\}}
\DoxyCodeLine{   cd \$\{\mbox{\hyperlink{build__virtualbox_8sh_a62ad76d689932a98f7cc9667b6fa903d}{VMPATH}}\}}
\DoxyCodeLine{   delete\_vm \$\{VM\} \textcolor{stringliteral}{"vdi"}}
\DoxyCodeLine{   VBoxManage createvm -\/-\/name \textcolor{stringliteral}{"\$\{VM\}"} -\/-\/ostype gentoo\_64  -\/-\/\textcolor{keyword}{register}  -\/-\/basefolder \textcolor{stringliteral}{"\$\{VMPATH\}"}}
\DoxyCodeLine{   VBoxManage modifyvm \textcolor{stringliteral}{"\$\{VM\}"} -\/-\/cpus \$\{NCPUS\} -\/-\/cpu-\/profile host -\/-\/memory \$\{MEM\} -\/-\/vram 256 -\/-\/ioapic on -\/-\/usbxhci on -\/-\/usbehci on}
\DoxyCodeLine{   VBoxManage createhd -\/-\/filename \textcolor{stringliteral}{"\$\{VM\}.vdi"} -\/-\/size \$\{SIZE\} -\/-\/variant Standard}
\DoxyCodeLine{   VBoxManage storagectl \textcolor{stringliteral}{"\$\{VM\}"} -\/-\/name \textcolor{stringliteral}{"SATA Controller"} -\/-\/add sata -\/-\/bootable on}
\DoxyCodeLine{   VBoxManage storageattach \textcolor{stringliteral}{"\$\{VM\}"} -\/-\/storagectl \textcolor{stringliteral}{"SATA Controller"}  -\/-\/medium \textcolor{stringliteral}{"\$\{VM\}.vdi"} -\/-\/port 0 -\/-\/device 0 -\/-\/type hdd}
\DoxyCodeLine{   VBoxManage storagectl \textcolor{stringliteral}{"\$\{VM\}"} -\/-\/name \textcolor{stringliteral}{"IDE Controller"} -\/-\/add ide}
\DoxyCodeLine{   VBoxManage storageattach \textcolor{stringliteral}{"\$\{VM\}"} -\/-\/storagectl \textcolor{stringliteral}{"IDE Controller"}  -\/-\/port 0  -\/-\/device 0   -\/-\/type dvddrive -\/-\/medium \$\{LIVECD\}  -\/-\/tempeject on}
\DoxyCodeLine{   VBoxManage storageattach \textcolor{stringliteral}{"\$\{VM\}"} -\/-\/storagectl \textcolor{stringliteral}{"IDE Controller"}  -\/-\/port 0  -\/-\/device 1   -\/-\/type dvddrive -\/-\/medium emptydrive}
\DoxyCodeLine{   VBoxManage startvm \textcolor{stringliteral}{"\$\{VM\}"} -\/-\/type \$\{VMTYPE\}}
\DoxyCodeLine{\textcolor{preprocessor}{   \# VM is created in a separate process}}
\DoxyCodeLine{\textcolor{preprocessor}{   \# Wait for it to come to end}}
\DoxyCodeLine{\textcolor{preprocessor}{   \# Test if still running every minute}}
\DoxyCodeLine{   \textcolor{keywordflow}{while} test\_vm\_running \$\{VM\}; \textcolor{keywordflow}{do}}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"\$\{VM\} running..."}}
\DoxyCodeLine{       sleep 60}
\DoxyCodeLine{   done}
\DoxyCodeLine{   VBoxManage modifyhd \textcolor{stringliteral}{"\$\{VM\}.vdi"} -\/-\/compact}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} clonezilla\_to\_iso \{}
\DoxyCodeLine{   \textcolor{keywordflow}{if} ! test -\/f \textcolor{stringliteral}{"\$\{VMPATH\}/\$2"}/syslinux/isohdpfx.bin; then}
\DoxyCodeLine{       sudo cp -\/vf \$\{\mbox{\hyperlink{build__virtualbox_8sh_a62ad76d689932a98f7cc9667b6fa903d}{VMPATH}}\}/clonezilla/syslinux/isohdpfx.bin \textcolor{stringliteral}{"\$\{VMPATH\}/\$2"}/syslinux}
\DoxyCodeLine{   fi}
\DoxyCodeLine{   xorriso -\/as mkisofs   -\/isohybrid-\/mbr \textcolor{stringliteral}{"\$2"}/syslinux/isohdpfx.bin  \(\backslash\)}
\DoxyCodeLine{           -\/c syslinux/boot.cat   -\/b syslinux/isolinux.bin   -\/no-\/emul-\/boot \(\backslash\)}
\DoxyCodeLine{           -\/boot-\/load-\/size 4   -\/boot-\/info-\/table   -\/eltorito-\/alt-\/boot   -\/e boot/grub/efiboot.img \(\backslash\)}
\DoxyCodeLine{           -\/no-\/emul-\/boot   -\/isohybrid-\/gpt-\/basdat   -\/o \textcolor{stringliteral}{"\$1"}  \textcolor{stringliteral}{"\$2"}}
\DoxyCodeLine{   \textcolor{keywordflow}{if} test \$? != 0; then}
\DoxyCodeLine{       echo \textcolor{stringliteral}{"Could not create ISO image from ISO package creation directory"}}
\DoxyCodeLine{       exit -\/1}
\DoxyCodeLine{   fi}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} process\_clonezilla\_iso \{}
\DoxyCodeLine{   fetch\_clonezilla\_iso}
\DoxyCodeLine{   \textcolor{keywordflow}{for} i in proc sys dev run; \textcolor{keywordflow}{do} sudo mount -\/B /\$i squashfs-\/root/\$i; done}
\DoxyCodeLine{   sudo chroot squashfs-\/root}
\DoxyCodeLine{   sudo mkdir /boot}
\DoxyCodeLine{   sudo apt update -\/yq}
\DoxyCodeLine{   sudo apt upgrade -\/yq <<< \$(echo N)}
\DoxyCodeLine{   local headers=\$(apt-\/cache search \string^linux-\/headers | tail -\/n1 | cut -\/f 1 -\/d\textcolor{charliteral}{' '})}
\DoxyCodeLine{   local kernel=\$(apt-\/cache search \string^linux-\/image | grep -\/v \textcolor{keywordtype}{unsigned} | tail -\/n1 | cut -\/f 1 -\/d\textcolor{charliteral}{' '})}
\DoxyCodeLine{   sudo apt install -\/qy \$\{headers\}}
\DoxyCodeLine{   sudo apt install -\/qy \$\{kernel\}}
\DoxyCodeLine{   sudo apt install -\/qy build-\/essential gcc <<< \$(echo N)}
\DoxyCodeLine{   sudo apt install -\/qy virtualbox-\/dkms}
\DoxyCodeLine{   sudo apt install -\/qy virtualbox-\/guest-\/additions-\/iso}
\DoxyCodeLine{   sudo mount -\/oloop /usr/share/virtualbox/VBoxGuestAdditions.iso /mnt}
\DoxyCodeLine{   cd /mnt}
\DoxyCodeLine{   /sbin/rcvboxadd quicksetup all}
\DoxyCodeLine{   sudo /bin/bash VBoxLinuxAdditions.run}
\DoxyCodeLine{   cd /}
\DoxyCodeLine{   sudo umount /mnt}
\DoxyCodeLine{   sudo apt remove -\/y -\/q \$\{headers\} build-\/essential gcc  virtualbox-\/guest-\/additions-\/iso}
\DoxyCodeLine{   sudo apt autoremove -\/y -\/q}
\DoxyCodeLine{   exit}
\DoxyCodeLine{   sudo cp -\/vf -\/-\/dereference squashfs-\/root/boot/vmlinuz  vmlinuz}
\DoxyCodeLine{   sudo cp -\/vf -\/-\/dereference squashfs-\/root/boot/initrd.img  initrd.img}
\DoxyCodeLine{   sudo rm -\/rf squashfs-\/root/boot}
\DoxyCodeLine{   sudo rm -\/vf filesystem.squashfs}
\DoxyCodeLine{   \textcolor{keywordflow}{for} i in proc sys dev  run; \textcolor{keywordflow}{do} sudo umount squashfs-\/root/\$i; done}
\DoxyCodeLine{   sudo mksquashfs squashfs-\/root filesystem.squashfs}
\DoxyCodeLine{   sudo rm -\/rf squashfs-\/root/}
\DoxyCodeLine{   cd \textcolor{stringliteral}{"\$\{VMPATH\}/mnt2"}}
\DoxyCodeLine{   sudo cp -\/vf ../clonezilla/savedisk/isolinux.cfg  syslinux}
\DoxyCodeLine{   cd \textcolor{stringliteral}{"\$\{VMPATH\}"}}
\DoxyCodeLine{   sudo rm -\/vf \$\{CLONEZILLACD\}}
\DoxyCodeLine{   echo}
\DoxyCodeLine{   clonezilla\_to\_iso \$\{CLONEZILLACD\} \textcolor{stringliteral}{"mnt2"}}
\DoxyCodeLine{   sudo rm -\/rf mnt2}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{function} build\_virtualbox \{}
\DoxyCodeLine{   cd \$\{\mbox{\hyperlink{build__virtualbox_8sh_a62ad76d689932a98f7cc9667b6fa903d}{VMPATH}}\}}
\DoxyCodeLine{   cp -\/vf clonezilla/build\textcolor{comment}{/* \$\{CLONEZILLACD\}/live}}
\DoxyCodeLine{\textcolor{comment}{   cd \$\{CLONEZILLACD\}/live}}
\DoxyCodeLine{\textcolor{comment}{   ./build\_clonezilla.sh}}
\DoxyCodeLine{\textcolor{comment}{   cd \$\{VMPATH\}}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function create\_iso\_vm \{}}
\DoxyCodeLine{\textcolor{comment}{   cd \$\{VMPATH\}}}
\DoxyCodeLine{\textcolor{comment}{   process\_clonezilla\_iso}}
\DoxyCodeLine{\textcolor{comment}{   gpasswd -\/a \$\{USER\} -\/g vboxusers}}
\DoxyCodeLine{\textcolor{comment}{   chgrp vboxusers "ISOFILES/home/partimag/image"}}
\DoxyCodeLine{\textcolor{comment}{   delete\_vm \$\{ISOVM\}}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage createvm -\/-\/name "\$\{ISOVM\}" -\/-\/ostype ubuntu\_64  -\/-\/register  -\/-\/basefolder "\$\{VMPATH\}"}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage modifyvm "\$\{ISOVM\}" -\/-\/cpus \$\{NCPUS\} -\/-\/cpu-\/profile host -\/-\/memory \$\{MEM\} -\/-\/vram 256 -\/-\/ioapic on -\/-\/usbxhci on -\/-\/usbehci on}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage storagectl "\$\{ISOVM\}" -\/-\/name "SATA Controller" -\/-\/add sata -\/-\/bootable on}}
\DoxyCodeLine{\textcolor{comment}{   \# This to avoid issues with already-\/used vdis in debug tests}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage internalcommands sethduuid "\$\{ISOVM.vdi\}"}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage storageattach "\$\{ISOVM\}" -\/-\/storagectl "SATA Controller"  -\/-\/medium "\$\{ISOVM\}.vdi" -\/-\/port 0 -\/-\/device 0 -\/-\/type hdd}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage storagectl "\$\{ISOVM\}" -\/-\/name "IDE Controller" -\/-\/add ide}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage storageattach "\$\{ISOVM\}" -\/-\/storagectl "IDE Controller"  -\/-\/port 0  -\/-\/device 0   -\/-\/type dvddrive -\/-\/medium \$\{CLONEZILLACD\}  -\/-\/tempeject on}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage storageattach "\$\{ISOVM\}" -\/-\/storagectl "IDE Controller"  -\/-\/port 0  -\/-\/device 1   -\/-\/type dvddrive -\/-\/medium emptydrive}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage startvm "\$\{ISOVM\}" -\/-\/type \$\{VMTYPE\}}}
\DoxyCodeLine{\textcolor{comment}{   \# must be running to work: note, requests 6.1.14 at least}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage sharedfolder add "\$\{ISOVM\}" -\/-\/name shared -\/-\/hostpath "\$\{VMPATH\}/ISOFILES/home/partimag/image"  -\/-\/automount -\/-\/auto-\/mount-\/point "/home/partimag" -\/-\/transient}}
\DoxyCodeLine{\textcolor{comment}{   while test\_vm\_running \$\{ISOVM\}; do}}
\DoxyCodeLine{\textcolor{comment}{       echo "\$\{ISOVM\} running..."}}
\DoxyCodeLine{\textcolor{comment}{       sleep 60}}
\DoxyCodeLine{\textcolor{comment}{   done}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{\# Gives device from mount folder input}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function get\_device \{}}
\DoxyCodeLine{\textcolor{comment}{   if test -\/d "\$1"; then}}
\DoxyCodeLine{\textcolor{comment}{       device=\$(findmnt -\/-\/raw -\/-\/first -\/a -\/n -\/c \$1 | cut -\/f2 -\/d' ')}}
\DoxyCodeLine{\textcolor{comment}{   else}}
\DoxyCodeLine{\textcolor{comment}{       if is\_block\_device "\$1"; then}}
\DoxyCodeLine{\textcolor{comment}{           echo "\$1"}}
\DoxyCodeLine{\textcolor{comment}{       else}}
\DoxyCodeLine{\textcolor{comment}{           echo "\$1 is neither a mountpoint nor a block device"}}
\DoxyCodeLine{\textcolor{comment}{           exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{       fi}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   echo \$\{device\}}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function list\_block\_devices \{}}
\DoxyCodeLine{\textcolor{comment}{   echo  "\$(lsblk -\/a -\/n -\/o KNAME | grep -\/v loop)"}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{\# Returns 0 (true) if input is a block device otherwise 1}}
\DoxyCodeLine{\textcolor{comment}{function is\_block\_device \{}}
\DoxyCodeLine{\textcolor{comment}{   local devices=\$(list\_block\_devices)}}
\DoxyCodeLine{\textcolor{comment}{   grep -\/q "\$1" <<< "\$\{devices\}" \&\& return 0}}
\DoxyCodeLine{\textcolor{comment}{   return 1}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{\# Gives mount folder from device label input}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function get\_mountpoint \{}}
\DoxyCodeLine{\textcolor{comment}{   if is\_block\_device "\$1"; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "\$1  is not a block device!"}}
\DoxyCodeLine{\textcolor{comment}{       echo "Device labels should be in the following list:"}}
\DoxyCodeLine{\textcolor{comment}{       echo \$(list\_block\_devices)}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   echo "\$(findmnt -\/-\/raw -\/-\/first -\/a -\/n -\/c "\$1" | cut -\/f1 -\/d' ')"}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{function clone\_vm\_to\_usb \{}}
\DoxyCodeLine{\textcolor{comment}{   \# Test whether USB\_DEVICE is a mountpoint or a block device label}}
\DoxyCodeLine{\textcolor{comment}{   USB\_DEVICE=\$(get\_device \$\{USB\_DEVICE\})}}
\DoxyCodeLine{\textcolor{comment}{   \# Should not occur, only for paranoia}}
\DoxyCodeLine{\textcolor{comment}{   if test "\$\{USB\_DEVICE\}" = ""; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Could not set USB device \$\{USB\_DEVICE\}"}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   \# Using the custom-\/patched version of the vbox-\/img utility:}}
\DoxyCodeLine{\textcolor{comment}{   bin/vbox-\/img compact -\/-\/filename "\$\{VMPATH\}/\$\{VM\}.vdi"}}
\DoxyCodeLine{\textcolor{comment}{   bin/vbox-\/img convert -\/-\/srcfilename "\$\{VMPATH\}/\$\{VM\}.vdi" -\/-\/stdout -\/-\/dstformat RAW | dd of=/dev/\$\{USB\_DEVICE\} bs=4M status=progress}}
\DoxyCodeLine{\textcolor{comment}{   if test \$? = 0; then}}
\DoxyCodeLine{\textcolor{comment}{       sync}}
\DoxyCodeLine{\textcolor{comment}{       return \$?}}
\DoxyCodeLine{\textcolor{comment}{   else}}
\DoxyCodeLine{\textcolor{comment}{       echo "Could not convert dynamic virtual disk to raw USB device!"}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function clone\_vm\_to\_raw \{}}
\DoxyCodeLine{\textcolor{comment}{   VBoxManage clonemedium "\$\{VMPATH\}/\$\{VM\}.vdi" "\$\{VMPATH\}/tmpdisk.raw" -\/-\/format RAW}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function dd\_to\_usb \{}}
\DoxyCodeLine{\textcolor{comment}{   "Bare metal copy of RAW disk to USB device..."}}
\DoxyCodeLine{\textcolor{comment}{   \# Test whether USB\_DEVICE is a mountpoint or a block device label}}
\DoxyCodeLine{\textcolor{comment}{   USB\_DEVICE=\$(get\_device \$\{USB\_DEVICE\})}}
\DoxyCodeLine{\textcolor{comment}{   \# Should not occur, only for paranoia}}
\DoxyCodeLine{\textcolor{comment}{   if test "\$\{USB\_DEVICE\}" = ""; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Could not set USB device \$\{USB\_DEVICE\}"}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   dd if="\$\{VMPATH\}/tmpdisk.raw" of=/dev/\$\{USB\_DEVICE\} bs=4M status=progress}}
\DoxyCodeLine{\textcolor{comment}{   if test \$? = 0; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Removing temporary RAW disk..."}}
\DoxyCodeLine{\textcolor{comment}{       rm -\/f \$\{VMPATH\}/tmpdisk.raw}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   return \$?}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function clonezilla\_usb\_to\_image \{}}
\DoxyCodeLine{\textcolor{comment}{   find\_ocs\_sr=`which ocs-\/sr`}}
\DoxyCodeLine{\textcolor{comment}{   if test "\$find\_ocs\_sr" = ""; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Could not find ocs\_sr !"}}
\DoxyCodeLine{\textcolor{comment}{       echo "Install Clonezilla in a standard path or rerun after adding its parth to the PATH environment variable"}}
\DoxyCodeLine{\textcolor{comment}{       echo "Note: Debian-\/based distributions provide a handy `clonezilla` package."}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   \# At this stage USB\_DEVICE can no longer be a mountpoint as it has been previously converted to device label}}
\DoxyCodeLine{\textcolor{comment}{   findmnt /dev/\$\{USB\_DEVICE\}  \&\& echo "Device \$\{USB\_DEVICE\} is mounted to: \$(get\_mountpoint /dev/\$\{USB\_DEVICE\})"  \&\& echo "The external USB device should not be mounted"  \&\& echo "Trying to unmount..." \&\& sudo umount -\/l /dev/\$\{USB\_DEVICE\}}}
\DoxyCodeLine{\textcolor{comment}{   if test \$? =0; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Managed to unmount /dev/\$\{USB\_DEVICE\}"}}
\DoxyCodeLine{\textcolor{comment}{   else}}
\DoxyCodeLine{\textcolor{comment}{       echo "Could not manage to unmount external USB device"}}
\DoxyCodeLine{\textcolor{comment}{       echo "Unmount it manually and rerun."}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   \# double check}}
\DoxyCodeLine{\textcolor{comment}{   if  test `findmnt /dev/\$\{USB\_DEVICE\}`; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Impossible to unmount device \$\{USB\_DEVICE\}"}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   if test -\/d /home/partimag; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "/home/partimag needs to be wiped out..."}}
\DoxyCodeLine{\textcolor{comment}{       echo "Trying with user rights..."}}
\DoxyCodeLine{\textcolor{comment}{       rm -\/rf /home/partimag}}
\DoxyCodeLine{\textcolor{comment}{       if test \$? != 0; then}}
\DoxyCodeLine{\textcolor{comment}{           echo "Directory /home/partimag needs elevated rights..."}}
\DoxyCodeLine{\textcolor{comment}{           echo "Waiting for sudo passwd..."}}
\DoxyCodeLine{\textcolor{comment}{           sudo  rm -\/rf /home/partimag}}
\DoxyCodeLine{\textcolor{comment}{           if test \$? != 0; then}}
\DoxyCodeLine{\textcolor{comment}{               echo "Could not fix /home/partimag issue."}}
\DoxyCodeLine{\textcolor{comment}{               exit -\/1;}}
\DoxyCodeLine{\textcolor{comment}{           fi}}
\DoxyCodeLine{\textcolor{comment}{       fi}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   if test \$\{CLEANUP\} = "true"; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Erasing virtual disk and virtual machine to save disk space..."}}
\DoxyCodeLine{\textcolor{comment}{       rm -\/f "\$\{VMPATH\}/\$\{VM\}.vdi"}}
\DoxyCodeLine{\textcolor{comment}{       rm -\/rf "\$\{VMPATH\}/\$\{VM\}"}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   rm -\/rf ISOFILES/home/partimag/image/*}}
\DoxyCodeLine{\textcolor{comment}{   if test \$? != 0; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Could not remove old Clonezilla image"}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   sudo ln -\/s  \$\{VMPATH\}/ISOFILES/home/partimag/image  /home/partimag}}
\DoxyCodeLine{\textcolor{comment}{   /usr/sbin/ocs-\/sr -\/q2 -\/c -\/j2 -\/nogui -\/batch -\/gm -\/gmf -\/noabo -\/z5 \(\backslash\)}}
\DoxyCodeLine{\textcolor{comment}{                    -\/i 40960000000 -\/fsck -\/senc -\/p poweroff savedisk gentoo.img \$\{USB\_DEVICE\}}}
\DoxyCodeLine{\textcolor{comment}{   if test \$? = 0 -\/a -\/f /home/partimag/gentoo.img; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Cloning succeeded!"}}
\DoxyCodeLine{\textcolor{comment}{   else}}
\DoxyCodeLine{\textcolor{comment}{       echo "Cloning failed!"}}
\DoxyCodeLine{\textcolor{comment}{       exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   return 0}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function burn\_iso \{}}
\DoxyCodeLine{\textcolor{comment}{   res=0}}
\DoxyCodeLine{\textcolor{comment}{   if test \$\{BURN\} = "true"; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Burning installation medium to optical disc..."}}
\DoxyCodeLine{\textcolor{comment}{       if test "\$\{SCSI\_ADDRESS\}" = ""; then}}
\DoxyCodeLine{\textcolor{comment}{           cdrecord "\$\{LIVECD\}"}}
\DoxyCodeLine{\textcolor{comment}{       else}}
\DoxyCodeLine{\textcolor{comment}{           cdrecord "\$\{LIVECD\}" dev=\$\{SCSI\_ADDRESS\}}}
\DoxyCodeLine{\textcolor{comment}{       fi}}
\DoxyCodeLine{\textcolor{comment}{       res=\$?}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   return \$\{res\}}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function create\_install\_usb\_device \{}}
\DoxyCodeLine{\textcolor{comment}{   res=0}}
\DoxyCodeLine{\textcolor{comment}{   if test \$\{USB\_INSTALLER\} = "true"; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Creating installation stick..."}}
\DoxyCodeLine{\textcolor{comment}{       dd if=\$\{LIVECD\} of=/dev/\$\{USB\_DEVICE\} bs=4M status=progress}}
\DoxyCodeLine{\textcolor{comment}{       res=\$?}}
\DoxyCodeLine{\textcolor{comment}{       sync}}
\DoxyCodeLine{\textcolor{comment}{       res=\$? | res}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   return \$\{res\}}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function vbox\_img\_works \{}}
\DoxyCodeLine{\textcolor{comment}{   cd \$\{VMPATH\}}}
\DoxyCodeLine{\textcolor{comment}{   if test "\$(bin/vbox-\/img -\/-\/version)" != ""; then}}
\DoxyCodeLine{\textcolor{comment}{       return 0}}
\DoxyCodeLine{\textcolor{comment}{   else}}
\DoxyCodeLine{\textcolor{comment}{       return 1}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function create\_usb\_system \{}}
\DoxyCodeLine{\textcolor{comment}{   if ! vbox\_img\_works -\/o \$\{BUILD\_VIRTUALBOX\} = "true"; then}}
\DoxyCodeLine{\textcolor{comment}{       build\_virtualbox}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   if  vbox\_img\_works; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "Cloning virtual disk to USB device \$\{USB\_DEVICE\} ..."}}
\DoxyCodeLine{\textcolor{comment}{       clone\_vm\_to\_usb}}
\DoxyCodeLine{\textcolor{comment}{       if test \$? != 0; then}}
\DoxyCodeLine{\textcolor{comment}{           echo "Cloning VDI disk to USB deice failed !"}}
\DoxyCodeLine{\textcolor{comment}{           exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{       fi}}
\DoxyCodeLine{\textcolor{comment}{   else}}
\DoxyCodeLine{\textcolor{comment}{       echo "Cloning virtual disk to raw..."}}
\DoxyCodeLine{\textcolor{comment}{       clone\_vm\_to\_raw}}
\DoxyCodeLine{\textcolor{comment}{       if test \$? != 0; then}}
\DoxyCodeLine{\textcolor{comment}{           echo "Cloning VDI disk to RAW failed !"}}
\DoxyCodeLine{\textcolor{comment}{           exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{       fi}}
\DoxyCodeLine{\textcolor{comment}{       echo}}
\DoxyCodeLine{\textcolor{comment}{       echo "Copying to USB stick..."}}
\DoxyCodeLine{\textcolor{comment}{       echo}}
\DoxyCodeLine{\textcolor{comment}{       dd\_to\_usb}}
\DoxyCodeLine{\textcolor{comment}{       echo}}
\DoxyCodeLine{\textcolor{comment}{       if test \$? != 0; then}}
\DoxyCodeLine{\textcolor{comment}{           echo "Copying raw file to USB device failed!"}}
\DoxyCodeLine{\textcolor{comment}{           echo "Check that your USB device has at least 50 GiB of reachable space"}}
\DoxyCodeLine{\textcolor{comment}{           exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{       fi}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   echo "Launching Clonezilla to create compressed image..."}}
\DoxyCodeLine{\textcolor{comment}{   echo}}
\DoxyCodeLine{\textcolor{comment}{   \# Succeeds or exits}}
\DoxyCodeLine{\textcolor{comment}{   clonezilla\_usb\_to\_image}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{function cleanup  \{}}
\DoxyCodeLine{\textcolor{comment}{   if test "\$\{CLEANUP\}" != "true"; then}}
\DoxyCodeLine{\textcolor{comment}{       return 0}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   cd \$\{VMPATH\}}}
\DoxyCodeLine{\textcolor{comment}{   rm *.xz}}
\DoxyCodeLine{\textcolor{comment}{   rm *.iso}}
\DoxyCodeLine{\textcolor{comment}{   rm -\/rf ISOFILES}}
\DoxyCodeLine{\textcolor{comment}{   if test -\/d mnt; then}}
\DoxyCodeLine{\textcolor{comment}{       sudo umount -\/l mnt}}
\DoxyCodeLine{\textcolor{comment}{       rmdir mnt}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   if test -\/d mnt2; then}}
\DoxyCodeLine{\textcolor{comment}{       sudo rm -\/rf mnt2}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{   rm -\/rvf \$\{VM\}}}
\DoxyCodeLine{\textcolor{comment}{   rm -\/vf \$\{VM\}.vdi}}
\DoxyCodeLine{\textcolor{comment}{   exit 0}}
\DoxyCodeLine{\textcolor{comment}{\}}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{}}
\DoxyCodeLine{\textcolor{comment}{if test "\$(echo \$\{CLI\} | sed 's/help\_md//' )" != "\$\{CLI\}"; then}}
\DoxyCodeLine{\textcolor{comment}{   help\_md}}
\DoxyCodeLine{\textcolor{comment}{   exit 0}}
\DoxyCodeLine{\textcolor{comment}{fi}}
\DoxyCodeLine{\textcolor{comment}{if test "\$(echo \$\{CLI\} | sed 's/help//' )" != "\$\{CLI\}"; then}}
\DoxyCodeLine{\textcolor{comment}{   help}}
\DoxyCodeLine{\textcolor{comment}{   exit 0}}
\DoxyCodeLine{\textcolor{comment}{fi}}
\DoxyCodeLine{\textcolor{comment}{echo "PARAMETERS"}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{for ((i=0; i<ARRAY\_LENGTH; i++)) ; do test\_cli \$i; done}}
\DoxyCodeLine{\textcolor{comment}{export VERSION}}
\DoxyCodeLine{\textcolor{comment}{export VERSION\_FULL}}
\DoxyCodeLine{\textcolor{comment}{export VMPATH}}
\DoxyCodeLine{\textcolor{comment}{export LINENO\_PATCH}}
\DoxyCodeLine{\textcolor{comment}{export DOWNLOAD\_CLONEZILLA\_PATH}}
\DoxyCodeLine{\textcolor{comment}{/bin/bash fetch\_clonezilla\_iso.sh}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{echo "Fetching live CD..."}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{fetch\_livecd}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{echo "Fetching stage3 tarball..."}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{fetch\_stage3}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{echo "Tweaking live CD..."}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{make\_boot\_from\_livecd}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{echo "Creating VM"}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{create\_vm}}
\DoxyCodeLine{\textcolor{comment}{if test \$? != 0; then}}
\DoxyCodeLine{\textcolor{comment}{   echo "VM failed to be created!"}}
\DoxyCodeLine{\textcolor{comment}{   exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{fi}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{if test \$\{CREATE\_ISO\} != "true"; then}}
\DoxyCodeLine{\textcolor{comment}{   cleanup}}
\DoxyCodeLine{\textcolor{comment}{fi}}
\DoxyCodeLine{\textcolor{comment}{if test "\$\{USB\_DEVICE\}" != ""; then}}
\DoxyCodeLine{\textcolor{comment}{   echo}}
\DoxyCodeLine{\textcolor{comment}{   echo "Building VirtualBox..."}}
\DoxyCodeLine{\textcolor{comment}{   echo}}
\DoxyCodeLine{\textcolor{comment}{   create\_usb\_system}}
\DoxyCodeLine{\textcolor{comment}{else}}
\DoxyCodeLine{\textcolor{comment}{   process\_clonezilla\_iso}}
\DoxyCodeLine{\textcolor{comment}{   create\_iso\_vm}}
\DoxyCodeLine{\textcolor{comment}{   echo}}
\DoxyCodeLine{\textcolor{comment}{   echo "Launching Clonezilla to create ISO install medium..."}}
\DoxyCodeLine{\textcolor{comment}{   echo}}
\DoxyCodeLine{\textcolor{comment}{fi}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{echo "Launching Clonezilla to create ISO install medium..."}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{clonezilla\_to\_iso \$\{LIVECD\} ISOFILES}}
\DoxyCodeLine{\textcolor{comment}{echo}}
\DoxyCodeLine{\textcolor{comment}{if test \$? = 0; then}}
\DoxyCodeLine{\textcolor{comment}{   echo "Done."}}
\DoxyCodeLine{\textcolor{comment}{   if test -\/f "\$\{ISO\_OUTPUT\}"; then}}
\DoxyCodeLine{\textcolor{comment}{       echo "ISO install medium was created here: \$\{ISO\_OUTPUT\}"}}
\DoxyCodeLine{\textcolor{comment}{   else}}
\DoxyCodeLine{\textcolor{comment}{       echo "ISO install medium failed to be created."}}
\DoxyCodeLine{\textcolor{comment}{   fi}}
\DoxyCodeLine{\textcolor{comment}{else}}
\DoxyCodeLine{\textcolor{comment}{   echo "ISO install medium failed to be created!"}}
\DoxyCodeLine{\textcolor{comment}{   exit -\/1}}
\DoxyCodeLine{\textcolor{comment}{fi}}
\DoxyCodeLine{\textcolor{comment}{cleanup}}
\end{DoxyCodeInclude}
 